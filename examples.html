<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>SpanSlicer Examples</title>
    <link rel="stylesheet" href="stylesheets/style.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <script src="js/jquery-1.4.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/jquery-ui-1.8.1.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/jquery-ui-dyndraggable.js" type="text/javascript" charset="utf-8"></script>
  </head>
  <body>
    <div id="spanner">
      <div id="ruler"></div>
      <div id="spans"></div>
    </div>
    
    <input type="button" value="Split selected" id="split_button"/>
    <input type="button" value="Delete selected" id="delete_button"/>
    <script type="text/javascript" charset="utf-8">
      var selectedIndex = 0;
      var nextOWidth = 0;
      var startPost = 0;
      var prevSpan = null;
      var nextSpan = null;
      var handleString = '<div class="handle"></div>';
      var updateInt = null;
      var handle = null;
      
      $(function() {
        buildRuler();
        buildSpans();
        $('.span').bind('click',selectSpan);
        $('#split_button').bind('click',splitSpan);
        $('#delete_button').bind('click',deleteSpan);
        enableDrag($('.span_div:has(.handle)'));
      });
      
      function buildRuler() {
        $("#ruler").append($('<div class="mark_div tall"></div>'));
        for (var i = 0; i < 96; i++) {
          $('#ruler').append($('<div class="ruler_block"><div class="inner"></div></div>'));
          var div_class = (i % 4 == 3) ? ' tall':''
          $('#ruler').append($('<div class="mark_div'+div_class+'"></div>'));
        }
      }
      
      function buildSpans() {
        $("#spans").append($('<div class="span" style="left:1px;width:1053px;" data-width="96" data-offset="0"><div class="inner selected"></div></div>'));
      }
      
      function splitSpan(event) {
        var spanToSplit = $('.span')[selectedIndex];
        if ($(spanToSplit).attr('data-width') != '1') {
          var widthCount = Number($(spanToSplit).attr('data-width'));
          var offCount = Number($(spanToSplit).attr('data-offset'));
          var leftSpan = $('<div style="left:'+(offCount*11+1).toString()+'px;width:'+(Math.floor(widthCount/2)*11 - 3).toString()+'px;" class="span" data-width="'+Math.floor(widthCount/2).toString()+'" data-offset="'+offCount.toString()+'"><div class="inner selected"></div></div>');
          var rightSpan = $('<div style="left:'+((offCount+Math.floor(widthCount/2))*11+1).toString()+'px;width:'+(((widthCount - Math.floor(widthCount/2))*11) - 3).toString()+'px;" class="span" data-width="'+(widthCount - Math.floor(widthCount/2)).toString()+'" data-offset="'+(offCount+Math.floor(widthCount/2)).toString()+'"><div class="inner"></div></div>');
          var spanDiv = $('<div style="position:absolute;left:'+((offCount+Math.floor(widthCount/2))*11).toString()+'px" class="span_div"></div>');
          if (Math.floor(widthCount/2) > 1 || (widthCount - Math.floor(widthCount/2)) > 1) {
            $(spanDiv).append($(handleString));
            enableDrag($(spanDiv));
          }
          rightSpan.bind('click',selectSpan);
          leftSpan.bind('click',selectSpan);
          $(spanToSplit).after(rightSpan).after(spanDiv).after(leftSpan);
          $(spanToSplit).remove();
          stripHandles();
        }
      }

      function deleteSpan() {
        if ($('.span').length > 1) {
          var spanToDelete = $($('.span')[selectedIndex]);
          if (selectedIndex == 0) {
            var nextSpan = $($('.span')[selectedIndex + 1]);
            nextSpan.css('left',spanToDelete.position().left);
            nextSpan.css('width',nextSpan.width()+spanToDelete.width()+3);
            nextSpan.attr('data-width',Number(nextSpan.attr('data-width'))+Number(spanToDelete.attr('data-width')));
            nextSpan.attr('data-offset',0);
            nextSpan.find('.inner').addClass("selected");
            var div = spanToDelete.next();
            div.dyndraggable("destroy");
            div.remove();
            spanToDelete.remove();
          } else {
            var prevSpan = $($('.span')[selectedIndex - 1]);
            prevSpan.css('width',prevSpan.width()+spanToDelete.width()+3);
            prevSpan.attr('data-width',Number(prevSpan.attr('data-width'))+Number(spanToDelete.attr('data-width')));
            prevSpan.find('.inner').addClass("selected");
            var div = spanToDelete.prev();
            div.dyndraggable("destroy");
            div.remove();
            spanToDelete.remove();
            selectedIndex--;
          }
          stripHandles();
        } else {
          alert("You can't delete your last timespan!");
        }
      }

      function enableDrag(set) {
        set.dyndraggable({
          axis:'x',
          handle:'.handle',
          grid: [11,1],
          containment: [11,1,1056,1],
          start: handleDragStart,
          stop: handleDragRelease
        });
      }

      function updateSpans(event,ui) {
        prevSpan.css('width',handle.position().left-prevSpan.position().left-2);
        nextSpan.css('left',handle.position().left+1);
        nextSpan.css('width',nextOWidth+(startPos-handle.position().left));
      }

      function handleDragRelease(event,ui) {
        prevSpan.attr('data-width',(prevSpan.width() + 3)/11);
        nextSpan.attr('data-width',(nextSpan.width() + 3)/11);
        nextSpan.attr('data-offset',(nextSpan.position().left - 1)/11);
        clearInterval(updateInt);
        stripHandles();
      }

      function handleDragStart(event,ui) {
        prevSpan = $(event.target).prev();
        nextSpan = $(event.target).next();
        handle = $(event.target);
        var prevDiv = $(event.target).prevAll('.span_div:first');
        var leftBound = (prevDiv.length > 0) ? $(prevDiv[0]).position().left + 11 : 11;
        var nextDiv = $(event.target).nextAll('.span_div:first');
        var rightBound = (nextDiv.length > 0) ? $(nextDiv[0]).position().left : 1056;
        $(event.target).dyndraggable("option", 'containment', [leftBound, 1, rightBound, 1]);
        startPos = $(event.target).position().left;
        nextOWidth = $(event.target).next().width();
        updateInt = setInterval(updateSpans,10);
      }

      function stripHandles() {
        $(".span_div").each(function(i) {
          var handle = $(this).find('.handle');
          if ($(this).next().attr('data-width') == '1' && $(this).prev().attr('data-width') == '1') {
            handle.remove();
            $(this).dyndraggable("destroy");
          } else if (handle.length == 0) {
            $(this).append($(handleString));
            enableDrag($(this));
          }
        });
      }

      function selectSpan(event) {
        $('.span').each(function(i) {
          if (this == event.currentTarget) {
            $(this).find('.inner').addClass("selected");
            selectedIndex = i;
          } else {
            $(this).find('.inner').removeClass("selected");
          }
        });
      }
    </script>
  </body>
</html>